<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        .child-block {
            margin-left: 20px;
        }

        .content-block {
            margin-left: 40px;
        }

        .accordion-button {
            /* Styling for your accordion buttons */
        }
    </style>
    <!-- Add your meta tags, title, and CSS links -->
</head>

<body>
    <div class="container">
        <div class="course-structure">
            {% macro render_block(block) %}
            <div class="block-accordion">
                <div class="block-header">
                    <button class="accordion-button" onclick="toggleAccordion({{ block.id }})">
                        {{ block.title }}
                    </button>
                    <button onclick="addChildBlock({{ block.id }})">+ Child Block</button>
                    <button onclick="addContent({{ block.id }})">+ Content</button>
                </div>
                <div id="accordion{{ block.id }}" class="block-content">
                    {% for child in block.children %}
                    <div class="child-block">
                        {{ render_block(child) }}
                    </div>
                    {% endfor %}
                    {% for content in block.contents %}
                    <div class="content-block">
                        {{ content.title }}
                        <!-- Add more content details here if necessary -->
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endmacro %}
            <!-- Iterate through blocks to create accordions -->
            {% for block in course.blocks %}
            <!-- Render top-level blocks; the macro will handle nesting -->
            {{ render_block(block) }}
            {% endfor %}
            <button onclick="addBlock()">Add Block</button>
        </div>
        <div class="edit-panel">
            <!-- This is where the form to create/edit blocks and content will appear -->
        </div>
    </div>
    <script>
        // JavaScript functions to handle adding blocks, adding child blocks, and adding content
        
        function toggleAccordion(blockId) {
            var accordion = document.getElementById('accordion' + blockId);
            accordion.style.display = accordion.style.display === 'none' ? 'block' : 'none';
        }
        
        
        function addBlock() {
            // Create the form HTML
            var formHtml = `
      <form id="add-block-form" action="/add_block" method="post">
        <input type="hidden" name="course_id" value="{{ course.id }}" />
        <div>
          <label for="block_title">Block Title:</label>
          <input type="text" id="block_title" name="block_title" required>
        </div>
        <!-- Add any additional fields you need here -->
        <div>
          <input type="submit" value="Add Block">
        </div>
      </form>
    `;

            // Insert the form into the right panel
            document.querySelector('.edit-panel').innerHTML = formHtml;

            // Add an event listener for form submission
            document.getElementById('add-block-form').addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent the default form submission

                var formData = new FormData(this);
                fetch('/course/edit_course/add_block', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Handle response data
                        console.log(data);
                        if (data.success) {
                            // Here, you could dynamically add the new block to the left panel
                            // without reloading the page, or simply reload the page to show the new block
                            location
                                .reload(); // This line reloads the page, you might want to replace this with dynamic DOM manipulation
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        }

        function addChildBlock(parentBlockId) {
            // Create the form HTML for adding a child block
            var formHtml = `
      <form id="add-child-block-form">
        <input type="hidden" name="parent_block_id" value="${parentBlockId}">
        <div>
          <label for="child_block_title">Child Block Title:</label>
          <input type="text" id="child_block_title" name="block_title" required>
        </div>
        <!-- Add any additional fields you need here -->
        <div>
          <button type="button" onclick="submitChildBlockForm()">Add Child Block</button>
        </div>
      </form>
    `;

            // Insert the form into the edit panel
            document.querySelector('.edit-panel').innerHTML = formHtml;
        }

        function submitChildBlockForm() {
            var formElement = document.getElementById('add-child-block-form');
            var formData = new FormData(formElement);

            fetch('/course/edit_course/add_child_block', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Handle response data
                    console.log(data);
                    if (data.success) {
                        // Update the UI to show the new child block
                        location.reload(); // Or dynamically update the DOM
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function addContent(blockId) {
            // Logic to add content to a block
        }
    </script>
</body>

</html>