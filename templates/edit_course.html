{% extends "base.html" %}
{% block title %}Edit Course{% endblock %}


{% block stylesheets %}
<style>
    body {
        font-family: Arial, sans-serif;
    }

    .container {
        display: flex;
        flex-direction: row;
        padding: 10px;
        max-width: 800px;
        margin: auto;
    }

    .course-structure {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        width: 99%;
        margin-right: 10px;
    }

    .edit-panel {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 5px;
        border-radius: 5px;
    }

    .block-accordion {
        background-color: #f9f9f9;
        margin-bottom: 5px;
        border-radius: 5px;
        padding: 5px 10px;
    }

    .block-name,
    .block-action-new {
        display: block;
        font-size: 10px;
    }

    .block-header {}

    .block-header>span {
        flex-grow: 1;
        font-weight: bold;
    }

    .block-header>button {
        margin-left: 5px;
        padding: 2px 5px;
        cursor: pointer;
        font-size: 8px;
    }

    .block-content {
        display: block;
        padding-left: 20px;
    }

    .child-block {
        background-color: #e7e7e7;
        margin-bottom: 5px;
        padding: 5px 10px;
        border-radius: 5px;
    }

    .add-block-btn {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        display: block;
        width: 100%;
        box-sizing: border-box;
        /* Ensures padding doesn't affect overall width */
        margin-top: 10px;
    }

    .accordion-button {
        padding: 1px 4px;
        /* Smaller padding */
        font-size: 12px;
        /* Smaller font size */
        margin: 0 5px;
        /* Adjust margin if necessary */
        cursor: pointer;
        background-color: #f0f0f0;
        /* Optional: background color */
        border: 1px solid #dcdcdc;
        /* Optional: border */
        border-radius: 4px;
        /* Rounded corners */
    }



    .add-block-btn:hover {
        background-color: #0056b3;
    }


    .container-box {
        display: flex;
    }

    .box-left {
        width: 30%;
        /* Adjust the width as needed */
        /* Add additional styling if needed */
    }

    .box-right {
        width: 70%
    }

    .content-block {
        cursor: pointer;
        padding: 5px;
        margin-bottom: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .content-block:hover {
        background-color: #f8f9fa;
    }

    form {
        margin-top: 20px;
    }

    form div {
        margin-bottom: 10px;
    }

    label {
        display: block;
        margin-bottom: 5px;
    }

    input[type="text"],
    textarea,
    select {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .file_preview img,
    .file_preview video,
    .file_preview embed,
    .file_preview iframe {
        max-width: 100%;
        height: auto;
        display: block;
        /* This centers the content in the div */
        margin: 0 auto;
        /* This also helps in centering the content */
    }
    video {
            width: 100%;
            height: auto;
        }

        
</style>
{% endblock %}
<!-- Add your meta tags, title, and CSS links -->


{% block content %}
<div class="container-top">
<a href="{{ url_for('update_course', course_id=course.id) }}" class="btn btn-success mb-3 right-link" >Update Parent Course Details</a></td>
</div>
<div class="container-box">
    <div class="box box-left">
        <div class="course-structure">
            {% macro render_block(block) %}
            <div class="block-accordion">
                <div class="block-header">
                    <div>
                        <button class="accordion-button"
                            onclick="toggleAccordion('block-content-{{ block.id }}')">&#9660;</button>
                        <span>{{ block.title }}</span>
                    </div>
                    <div class="block-action-new">
                        <a href="#" onclick="addChildBlock({{ block.id }})" class="text-success">+ Child Block | </a>
                        <a href="#" onclick="addContent({{ block.id }})" class="text-primary">+ Content | </a>
                        <a href="#" onclick="addAssessment({{ block.id }})" class="text-primary">+ Assessment |</a>
                        <a href="#" onclick="deleteBlock({{ block.id }})" class="text-danger">- Delete</a>
                    </div>
                </div>
                <div id="block-content-{{ block.id }}" class="block-content">
                    {% for child in block.children %}
                    <div class="child-block">
                        {{ render_block(child) }}
                    </div>
                    {% endfor %}
                    {% for content in block.contents %}
                    <div class="content-block" onclick="showEditContentForm({{ content.id }})">
                        {{ content.title }}
                        <!-- Add more content details here if necessary -->
                    </div>
                    {% endfor %}

                </div>
            </div>
            {% endmacro %}

            {% for block in course.blocks %}
            {% if block.parent_block_id is none %}
            {{ render_block(block) }}
            {% endif %}
            {% endfor %}
        </div>
        <button class="add-block-btn" onclick="addBlock()">Add Block</button>
    </div>
    <div class="box box-right">
        <div class="edit-panel">
            <!-- This is where the form to create/edit blocks and content will appear -->
        </div>
    </div>
</div>

{% endblock %}

{% block script %}

<script>
    // JavaScript functions to handle adding blocks, adding child blocks, and adding content

    function toggleAccordion(contentId) {
        var content = document.getElementById(contentId);
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
    }


    function addBlock() {
        // Create the form HTML
        var formHtml = `
      <form id="add-block-form" action="/add_block" method="post">
        <input type="hidden" name="course_id" value="{{ course.id }}" />
        <div>
          <label for="block_title">Block Title:</label>
          <input type="text" id="block_title" name="block_title" required>
        </div>
        <!-- Add any additional fields you need here -->
        <div>
          <input type="submit" value="Add Block">
        </div>
      </form>
    `;

        // Insert the form into the right panel
        document.querySelector('.edit-panel').innerHTML = formHtml;

        // Add an event listener for form submission
        document.getElementById('add-block-form').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the default form submission

            var formData = new FormData(this);
            fetch('/course/edit_course/add_block', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Handle response data
                    console.log(data);
                    if (data.success) {
                        // Here, you could dynamically add the new block to the left panel
                        // without reloading the page, or simply reload the page to show the new block
                        location
                            .reload(); // This line reloads the page, you might want to replace this with dynamic DOM manipulation
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    }

    function addChildBlock(parentBlockId) {
        // Create the form HTML for adding a child block
        var formHtml = `
      <form id="add-child-block-form">
        <input type="hidden" name="parent_block_id" value="${parentBlockId}">
        <div>
          <label for="child_block_title">Child Block Title:</label>
          <input type="text" id="child_block_title" name="block_title" required>
        </div>
        <!-- Add any additional fields you need here -->
        <div>
          <button type="button btn-add-child-block" onclick="submitChildBlockForm()">Add Child Block</button>
        </div>
      </form>
    `;

        // Insert the form into the edit panel
        document.querySelector('.edit-panel').innerHTML = formHtml;
    }

    function submitChildBlockForm() {
        var formElement = document.getElementById('add-child-block-form');
        var formData = new FormData(formElement);

        fetch('/course/edit_course/add_child_block', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Handle response data
                console.log(data);
                if (data.success) {
                    // Update the UI to show the new child block
                    location.reload(); // Or dynamically update the DOM
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function addContent(blockId) {

        // Create the form HTML
        var formHtml = `
      <form id="add-content-form">
        <input type="hidden" name="block_id" value="${blockId}">
        <div>
          <label for="content_title">Content Title:</label>
          <input type="text" id="content_title" name="content_title" required>
        </div>
        <div>
          <label for="about">About Content Title:</label>
          <textarea id="about" name="about"></textarea>
        </div>
        <div><label for="type">Type:</label>
        <select id="type" name="type">
            <option value="VideoLink">VideoLink</option>
            <option value="Video">Video</option>
            <option value="Text">Text</option>
            <option value="Doc">Doc</option>
            <option value="PDF">PDF</option>
            <option value="PPT">PPT</option>           
        </select><br></div>
        <div><label for="content_text">Text: (if content type is Text)</label>
            <textarea id="content_text" name="content_text"></textarea>
        </div>
        <div><label for="file">File:</label>
    <input type="file" id="file" name="file"><br></div>  
    <div>  
    <label for="videoLink">Video Link:</label>
    <input type="url" id="videoLink" name="videoLink" placeholder="Enter video URL">
    </div>   
    <div>
          <label for="transcript">Video Transcript: (if content type is video/vieoLink) </label>
          <textarea id="transcript" name="transcript"></textarea>
    </div>
     
    <div>
            <label for="mastery_score">Mastery Score:</label>
        <input type="number" id="mastery_score" name="mastery_score" min="0" max="100" value="100"><br>
        </div>
          <button type="button" onclick="submitContentForm()">Add Content</button>
        </div>
      </form>
    `;

        // Insert the form into the edit panel
        document.querySelector('.edit-panel').innerHTML = formHtml;
    }

    function submitContentForm() {
        var formElement = document.getElementById('add-content-form');
        var formData = new FormData(formElement);
        console.log(formData);
        fetch('/course/edit_course/add_content', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Handle response data
                if (data.success) {
                    // Update the UI to show the new content
                    // You might want to add the new content to the block's content list
                    // For now, we'll just reload to see the changes
                    location.reload();
                } else {
                    // Handle errors, display messages to the user
                    alert(data.error || 'An error occurred while adding content.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting the form.');
            });
    }

    function showEditContentForm(contentId) {
        fetch(`/course/edit_course/get_content/${contentId}`)
            .then(response => response.json())
            .then(data => {
                var formHtml = `
                <form id="edit-content-form">
    <input type="hidden" name="content_id" value="${data.id}">
    <div>
        <label for="content_title">Content Title:</label>
        <input type="text" id="content_title" name="content_title" required value="${data.title}">
    </div>
    <div>
        <label for="content_text">Content Text:</label>
        <textarea id="content_text" name="content_text">${data.text}</textarea>
    </div>
    <div>
          <label for="about">About Content Title:</label>
          <textarea id="about" name="about">${data.about}</textarea>
        </div>
    <div>
        <label for="type">Content Type:</label>
        <select id="type" name="type" value="${data.type}">
            <option value="Video">Video</option>
            <option value="Text">Text</option>
            <option value="PDF">PDF</option>
            <option value="PPT">PPT</option>
        </select><br></div>
    </div>
    <div>
        <label for="preview"></label>
        <div class="file_preview" style="max-width: 100%; height: auto; overflow: hidden;"></div>
    </div>
    <div>
        <label for="file">File:</label>
        <input type="file" id="file" name="file"><br>
        ${data.file_link}
    </div>
    ${data.videoLink ? `
            <div>
                <video controls>
                    <source src="${data.videoLink}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
        ` : ''}


    <div>
        <label for="videoLink">VideoLink:</label>
        <input type="text" id="videoLink" name="videoLink"><br>
        ${data.videoLink}
    </div>
    <div>
          <label for="transcript">Video Transcript: (if content type is video/vieoLink) </label>
          <textarea id="transcript" name="transcript">${data.transcript}</textarea>
    </div>
    <div>
        <label for="mastery_score">Mastery Score:</label>
        <input type="text" name="mastery_score" value="${data.mastery_score}">
    </div>
    <div>
        <button type="button" onclick="submitEditContentForm()">Update</button>
    </div>
</form>
            `;
                document.querySelector('.edit-panel').innerHTML = formHtml;
                const fileLink = data.file_link;
                const fileLink_adj = fileLink.replace('static/', '')
                const fileExtension = fileLink_adj.split('.').pop().toLowerCase();

                
                let filePreview = '';
                switch (fileExtension) {
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':
                        filePreview = `<img src="/${fileLink}" alt="Image">`;
                        break;
                        case 'mp4':
                        case 'avi':
                        case 'mov':
                            filePreview = `<video src="/${fileLink}" controls></video>`;
                            break;
                        case 'pdf':
                            filePreview = `<embed src="/${fileLink}" type="application/pdf" width="500" height="375">`;
                            break;
                        case 'ppt':
                        case 'pptx':
                            filePreview =
                                `<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(window.location.origin + '/' + fileLink)}&embedded=true" style="width:600px; height:400px;" frameborder="0"></iframe>`;
                            break;
                        case 'doc':
                        case 'docx':
                            filePreview =
                                `<iframe src="https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(window.location.origin + '/' + fileLink)}" style="width:600px; height:400px;" frameborder="0"></iframe>`;
                            break;
                            // Add cases for other file types if needed
                    default:
                        filePreview = 'No preview available';
                }
                console.log(filePreview)

                document.querySelector('.file_preview').innerHTML = filePreview;



            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function submitEditContentForm() {
        var formElement = document.getElementById('edit-content-form');
        var formData = new FormData(formElement);

        fetch('/course/edit_course/update_content/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    location.reload(); // Reload the page on successful response
                } else {
                    throw new Error('Network response was not ok.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was a problem with the request.');
            });
    }


    function addAssessment(blockId) {
        console.log("coming")
    }

    function deleteBlock(blockId) {
        console.log("coming")
    }
</script>

<script>
    CKEDITOR.replace('content_text');
</script>
{% endblock %}