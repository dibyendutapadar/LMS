{% extends "learner_base.html" %}

{% block stylesheets %}
<style>
    body {
        font-family: Arial, sans-serif;
    }

    .container {
        display: flex;
        flex-direction: row;
        padding: 10px;
        max-width: 800px;
        margin: auto;
    }

    .course-structure {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        width: 99%;
        margin-right: 10px;
    }

    .edit-panel {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 5px;
        border-radius: 5px;
    }

    .block-accordion {
        background-color: #f9f9f9;
        margin-bottom: 5px;
        border-radius: 5px;
        padding: 5px 10px;
    }

    .block-name,
    .block-action-new {
        display: block;
        font-size: 10px;
    }



    .block-header>span {
        flex-grow: 1;
        font-weight: bold;
    }

    .block-header>button {
        margin-left: 5px;
        padding: 2px 5px;
        cursor: pointer;
        font-size: 8px;
    }

    .block-content {
        display: block;
        padding-left: 20px;
    }

    .child-block {
        background-color: #e7e7e7;
        margin-bottom: 5px;
        padding: 5px 10px;
        border-radius: 5px;
    }

    .add-block-btn {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        display: block;
        width: 100%;
        box-sizing: border-box;
        /* Ensures padding doesn't affect overall width */
        margin-top: 10px;
    }

    .accordion-button {
        padding: 1px 4px;
        /* Smaller padding */
        font-size: 12px;
        /* Smaller font size */
        margin: 0 5px;
        /* Adjust margin if necessary */
        cursor: pointer;
        background-color: #f0f0f0;
        /* Optional: background color */
        border: 1px solid #dcdcdc;
        /* Optional: border */
        border-radius: 4px;
        /* Rounded corners */
    }



    .add-block-btn:hover {
        background-color: #0056b3;
    }


    .container-box {
        display: flex;
    }

    .box-left {
        width: 30%;
        /* Adjust the width as needed */
        /* Add additional styling if needed */
    }

    .box-right {
        width: 70%
    }

    .content-block {
        cursor: pointer;
        padding: 5px;
        margin-bottom: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .content-block:hover {
        background-color: #f8f9fa;
    }

    form {
        margin-top: 20px;
    }

    form div {
        margin-bottom: 10px;
    }

    label {
        display: block;
        margin-bottom: 5px;
    }

    input[type="text"],
    textarea,
    select {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .tabcontent {
        display: none;
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-top: none;
    }

    /* Style the buttons that are used to open the tab content */
    .tablink {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: background-color 0.3s;
    }

    /* Change background color of buttons on hover */
    .tablink:hover {
        background-color: #ddd;
    }

    /* Create an active/current tablink class */
    .tablink.active {
        background-color: #ccc;
    }
</style>
{% endblock %}


{% block content %}
<div class="container-box">
    <div class="box box-left">
        <div class="course-structure">
            <h3>{{course.title}}</h3>
            {% macro render_block(block) %}
            <div class="block-accordion">
                <div class="block-header">
                    <div>
                        <button class="accordion-button"
                            onclick="toggleAccordion('block-content-{{ block.id }}')">&#9660;</button>
                        <span>{{ block.title }}</span>
                    </div>
                    <!-- <div class="block-action-new">
                        <a href="#" onclick="addChildBlock({{ block.id }})" class="">+ Child Block | </a>
                        <a href="#" onclick="addContent({{ block.id }})" class="">+ Content | </a>
                        <a href="#" onclick="addAssessment({{ block.id }})" class="">+ Assessment |</a>
                        <a href="#" onclick="deleteBlock({{ block.id }})" class="">- Delete</a>
                    </div> -->
                </div>
                <div id="block-content-{{ block.id }}" class="block-content">
                    {% for child in block.children %}
                    <div class="child-block">
                        {{ render_block(child) }}
                    </div>
                    {% endfor %}
                    {% for content in block.contents %}
                    <div class="content-block" id="content-block" onclick="contentInitialized({{content.id}});showContent({{ content.id }}) ">
                        {{ content.title }}
                        <!-- Add more content details here if necessary -->
                    </div>
                    {% endfor %}

                </div>
            </div>
            {% endmacro %}

            {% for block in course.blocks %}
            {% if block.parent_block_id is none %}
            {{ render_block(block) }}
            {% endif %}
            {% endfor %}
        </div>

    </div>
    <div class="box box-right">
        <div class="edit-panel">
                <p style="display:block; height:100px" >Click on any Content from the left to view</p>
        </div>
        <div class="" style="display:none">
            <nav class="course-nav">
                <button class="tablink" onclick="openTab(event, 'About')">About</button>
                <button class="tablink" onclick="openTab(event, 'Transcript')">Transcript</button>
            </nav>
            <section id="About" class="tabcontent" style="display:none">
                <div>
                    <h2></h2>
                    <p id="about" class="about" style="display:none"></p>
                </div>
            </section>
            <section id="Transcript" class="tabcontent" style="display:none">
                <div>
                    <h2></h2>
                    <p id="transcript" class="transcript" style="display:none"></p>
                </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    function toggleAccordion(contentId) {
        var content = document.getElementById(contentId);
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
    }

    function showContent(contentId) {
        fetch(`/course/learn_course/get_content/${contentId}`)
            .then(response => response.json())
            .then(data => {
                let buttonHtml = data.completed ?
                    `<button type="button" id="MarkComplete" class="btn-success" disabled>Completed</button>` :
                    `<button type="button" id="MarkComplete" class="btn-primary" onclick="markComplete(${contentId})">MarkComplete</button>`;

                var formHtml = `
                <form id="show-content-form">
                    <input type="hidden" name="content_id" value="${data.id}">
                    <div>
                        <h3>${data.title}</h3>
                        <p>${data.text}</p>
                     </div>
                     ${data.videoLink ? `
                    <div>
                        <video id="myVideo" controls>
                        <source src="${data.videoLink}" type="video/mp4">
                        Your browser does not support the video tag.
                        </video>
                        <div id="watchedTime">Watched time: 0 seconds</div>
                    </div>
                    ` : ''}
                     <div>
                    <label for="preview">Preview</label>
                    <div class="file_preview" style="max-width: 100%; height: auto; overflow: hidden;"></div>
                    </div>
                    <div>${buttonHtml}</div>
                    <div>
                    <button type="button" id="goToNext" class="btn-primary" onclick="goToNext(${contentId})">Go To Next</button></div>
                </form>
            `;
                document.querySelector('.edit-panel').innerHTML = formHtml;
                console.log(data.about);
                console.log(data.file_link);
                document.querySelector('.about').textContent += data.about;
                document.querySelector('.transcript').textContent += data.transcript
                const fileLink = data.file_link;
                const fileLink_adj = fileLink.replace('static/', '')
                const fileExtension = fileLink_adj.split('.').pop().toLowerCase();


                let filePreview = '';
                switch (fileExtension) {
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':
                        filePreview = `<img src="/${fileLink}" alt="Image">`;
                        break;
                    case 'mp4':
                    case 'avi':
                    case 'mov':
                        filePreview = `<video id="myVideo" src="/${fileLink}" controls style="max-height: 500px; ></video><div id="watchedTime">Watched time: 0 seconds</div>`;
                        break;
                    case 'pdf':
                        filePreview = `<embed src="/${fileLink}" type="application/pdf" width="500" height="375">`;
                        break;
                    case 'ppt':
                    case 'pptx':
                        filePreview =
                            `<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(window.location.origin + '/' + fileLink)}&embedded=true" style="width:600px; height:400px;" frameborder="0"></iframe>`;
                        break;
                    case 'doc':
                    case 'docx':
                        filePreview =
                            `<iframe src="https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(window.location.origin + '/' + fileLink)}" style="width:600px; height:400px;" frameborder="0"></iframe>`;
                        break;
                        // Add cases for other file types if needed
                    default:
                        filePreview = 'No preview available';
                }
                console.log(filePreview)

                document.querySelector('.file_preview').innerHTML = filePreview;
                

            })
            .catch(error => {
                console.error('Error:', error);
            });
        

        console.log(body);
    }

    function markComplete(contentId) {
        fetch('/log_activity', {
            method: 'POST',
            body: JSON.stringify({
                learner_id: "{{ session.get('current_learner_id') }}",
                content_id: contentId,
                activity: "marked_completed",
                status: "completed",
                percentage_complete: 100
            }),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        console.log("completed");
        location.reload();
    }

    function contentInitialized(contentId){
        console.log("initialized");
        fetch('/log_activity', {
            method: 'POST',
            body: JSON.stringify({
                learner_id: "{{ session.get('current_learner_id') }}",
                content_id: contentId,
                activity: "initialized",
                status: "inprogress",
                percentage_complete: 0
            }),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
    }

</script>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        let video = document.getElementById('myVideo');
        let watchedTimeDisplay = document.getElementById('watchedTime');
        let watchedTime = 0;
        let lastTime = 0;

        video.addEventListener('timeupdate', function () {
            console.log(video.currentTime);
            if (video.currentTime > lastTime) {
                watchedTime += video.currentTime - lastTime;
            }
            lastTime = video.currentTime;
            watchedTimeDisplay.textContent = 'Watched time: ' + Math.round(watchedTime) + ' seconds';
        });
    });
</script>

{% endblock %}