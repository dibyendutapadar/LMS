{% extends "learner_base.html" %}

{% block stylesheets %}
<style>
    body {
        font-family: Arial, sans-serif;
    }

    .container {
        display: flex;
        flex-direction: row;
        padding: 10px;
        max-width: 800px;
        margin: auto;
    }

    .course-structure {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        width: 99%;
        margin-right: 10px;
    }

    .edit-panel {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 5px;
        border-radius: 5px;
    }

    .block-accordion {
        background-color: #f9f9f9;
        margin-bottom: 5px;
        border-radius: 5px;
        padding: 5px 10px;
    }

    .block-name,
    .block-action-new {
        display: block;
        font-size: 10px;
    }



    .block-header>span {
        flex-grow: 1;
        font-weight: bold;
    }

    .block-header>button {
        margin-left: 5px;
        padding: 2px 5px;
        cursor: pointer;
        font-size: 8px;
    }

    .block-content {
        display: block;
        padding-left: 20px;
    }

    .child-block {
        background-color: #e7e7e7;
        margin-bottom: 5px;
        padding: 5px 10px;
        border-radius: 5px;
    }

    .add-block-btn {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        display: block;
        width: 100%;
        box-sizing: border-box;
        /* Ensures padding doesn't affect overall width */
        margin-top: 10px;
    }

    .accordion-button {
        padding: 1px 4px;
        /* Smaller padding */
        font-size: 12px;
        /* Smaller font size */
        margin: 0 5px;
        /* Adjust margin if necessary */
        cursor: pointer;
        background-color: #f0f0f0;
        /* Optional: background color */
        border: 1px solid #dcdcdc;
        /* Optional: border */
        border-radius: 4px;
        /* Rounded corners */
    }



    .add-block-btn:hover {
        background-color: #0056b3;
    }


    .container-box {
        display: flex;
    }

    .box-left {
        width: 30%;
        /* Adjust the width as needed */
        /* Add additional styling if needed */
    }

    .box-right {
        width: 70%
    }

    .content-block {
        cursor: pointer;
        padding: 5px;
        margin-bottom: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .content-block:hover {
        background-color: #f8f9fa;
    }

    form {
        margin-top: 20px;
    }

    form div {
        margin-bottom: 10px;
    }

    label {
        display: block;
        margin-bottom: 5px;
    }

    input[type="text"],
    textarea,
    select {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .tabcontent {
        display: none;
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-top: none;
    }

    /* Style the buttons that are used to open the tab content */
    .tablink {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: background-color 0.3s;
    }

    /* Change background color of buttons on hover */
    .tablink:hover {
        background-color: #ddd;
    }

    /* Create an active/current tablink class */
    .tablink.active {
        background-color: #ccc;
    }
</style>
{% endblock %}


{% block content %}
<div class="container-box">
    <div class="box box-left">
        <div class="course-structure">
            <h3>{{course.title}}</h3>
            {% macro render_block(block) %}
            <div class="block-accordion">
                <div class="block-header">
                    <div>
                        <button class="accordion-button"
                            onclick="toggleAccordion('block-content-{{ block.id }}')">&#9660;</button>
                        <span>{{ block.title }}</span>
                    </div>
                    <!-- <div class="block-action-new">
                        <a href="#" onclick="addChildBlock({{ block.id }})" class="">+ Child Block | </a>
                        <a href="#" onclick="addContent({{ block.id }})" class="">+ Content | </a>
                        <a href="#" onclick="addAssessment({{ block.id }})" class="">+ Assessment |</a>
                        <a href="#" onclick="deleteBlock({{ block.id }})" class="">- Delete</a>
                    </div> -->
                </div>
                <div id="block-content-{{ block.id }}" class="block-content">
                    {% for child in block.children %}
                    <div class="child-block">
                        {{ render_block(child) }}
                    </div>
                    {% endfor %}
                    {% for content in block.contents %}
                    <div class="content-block" id="content-block" onclick="showContent({{ content.id }})">
                        {{ content.title }}
                        <!-- Add more content details here if necessary -->
                    </div>
                    {% endfor %}

                </div>
            </div>
            {% endmacro %}

            {% for block in course.blocks %}
            {% if block.parent_block_id is none %}
            {{ render_block(block) }}
            {% endif %}
            {% endfor %}
        </div>

    </div>
    <div class="box box-right">
        <div class="edit-panel">

        </div>
        <div class="course-details">
            <nav class="course-nav">
                <button class="tablink" onclick="openTab(event, 'About')">About</button>
                <button class="tablink" onclick="openTab(event, 'Transcript')">Transcript</button>
            </nav>
            <section id="About" class="tabcontent">
                <div>
                <h2>About this Course</h2>
                <p>Learn how to count without making mistakes.</p>
            </div>
            </section>
            <section id="Transcript" class="tabcontent" style="display:none">
                <div>
                <h2>Transcript</h2>
                <p>This is the transcript of the video...</p>
            </div>
            </section>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    function toggleAccordion(contentId) {
        var content = document.getElementById(contentId);
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
    }

    function showContent(contentId) {
        fetch(`/course/learn_course/get_content/${contentId}`)
            .then(response => response.json())
            .then(data => {
                let buttonHtml = data.completed ?
                    `<button type="button" id="MarkComplete" class="btn-success" disabled>Completed</button>` :
                    `<button type="button" id="MarkComplete" class="btn-primary" onclick="markComplete(${contentId})">MarkComplete</button>`;

                var formHtml = `
                <form id="show-content-form">
                    <input type="hidden" name="content_id" value="${data.id}">
                    <div>
                        <h3>${data.title}</h3>
                        <p>${data.text}</p>
                     </div>
                     ${data.videoLink ? `
                    <div>
                        <video controls>
                        <source src="${data.videoLink}" type="video/mp4">
                        Your browser does not support the video tag.
                        </video>
                    </div>
                    ` : ''}
                     <div>
                    <label for="preview">Preview</label>
                    <div class="file_preview" style="max-width: 100%; height: auto; overflow: hidden;"></div>
                    </div>
                    <div>${buttonHtml}</div>
                </form>
            `;
                document.querySelector('.edit-panel').innerHTML = formHtml;
                const fileLink = data.file_link;
                const fileLink_adj = fileLink.replace('static/', '')
                const fileExtension = fileLink_adj.split('.').pop().toLowerCase();


                let filePreview = '';
                switch (fileExtension) {
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':
                        filePreview = `<img src="/${fileLink}" alt="Image">`;
                        break;
                    case 'mp4':
                    case 'avi':
                    case 'mov':
                        filePreview = `<video src="/${fileLink}" controls></video>`;
                        break;
                    case 'pdf':
                        filePreview = `<embed src="/${fileLink}" type="application/pdf" width="500" height="375">`;
                        break;
                    case 'ppt':
                    case 'pptx':
                        filePreview =
                            `<iframe src="https://docs.google.com/gview?url=${encodeURIComponent(window.location.origin + '/' + fileLink)}&embedded=true" style="width:600px; height:400px;" frameborder="0"></iframe>`;
                        break;
                    case 'doc':
                    case 'docx':
                        filePreview =
                            `<iframe src="https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(window.location.origin + '/' + fileLink)}" style="width:600px; height:400px;" frameborder="0"></iframe>`;
                        break;
                        // Add cases for other file types if needed
                    default:
                        filePreview = 'No preview available';
                }
                console.log(filePreview)

                document.querySelector('.file_preview').innerHTML = filePreview;

            })
            .catch(error => {
                console.error('Error:', error);
            });
        fetch('/log_activity', {
            method: 'POST',
            body: JSON.stringify({
                learner_id: "{{ session.get('current_learner_id') }}",
                content_id: contentId,
                activity: "initialized",
                status: "inprogress",
                percentage_complete: 0
            }),
            headers: {
                'Content-Type': 'application/json'
            }
        });

        console.log(body);
    }

    function markComplete(contentId) {
        fetch('/log_activity', {
            method: 'POST',
            body: JSON.stringify({
                learner_id: "{{ session.get('current_learner_id') }}",
                content_id: contentId,
                activity: "marked_completed",
                status: "completed",
                percentage_complete: 100
            }),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        console.log("completed");
        location.reload();
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        // Example function to call the Flask backend to log the activity
        function logActivity(contentId, activity, status, percentageComplete) {
            fetch('/log_activity', {
                method: 'POST',
                body: JSON.stringify({
                    learner_id: "{{ session.get('current_learner_id') }}",
                    content_id: contentId,
                    activity: "marked_completed",
                    status: "completed",
                    percentage_complete: percentageComplete
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            });
        }



        // Log 'terminated' activity when the .edit-panel innerHTML changes
        const editPanel = document.querySelector('.edit-panel');
        const observer = new MutationObserver((mutationsList, observer) => {
            for (const mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    logActivity(editPanel.dataset.contentId, 'terminated', 'inprogress', 0);
                    // Optional: observer.disconnect(); if you want to stop observing after the change
                }
            }
        });
        observer.observe(editPanel, {
            childList: true,
            subtree: true
        });
        // Use a MutationObserver or another appropriate method to detect changes

        // Log 'terminated' activity before the window is unloaded
        window.addEventListener('beforeunload', () => {
            logActivity(editPanel.dataset.contentId, 'terminated', 'inprogress', 0);
        });
    });
</script>

<script>
    function openTab(evt, tabName) {
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablink" and remove the class "active"
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // Optional: Add this if you want the first tab to be open by default on page load
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById("defaultOpen").click();
    });
</script>

{% endblock %}